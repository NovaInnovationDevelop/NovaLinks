<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Redirigiendo — NovaLinks</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f8fafc; color:#111; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; }
    .card { background:#fff; padding:28px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.08); text-align:center; width:90%; max-width:420px; }
    .title { font-size:18px; font-weight:600; margin-bottom:12px; }
    .msg { color:#444; margin-bottom:16px; }
    .loading { width:44px; height:44px; border:4px solid #4f46e5; border-top-color:transparent; border-radius:50%; margin:0 auto 14px; animation:spin 1s linear infinite; }
    .error { color:#b91c1c; font-weight:600; }
    .small { font-size:13px; color:#666; margin-top:10px; word-break:break-all; }
    @keyframes spin { to { transform:rotate(360deg); } }
    a.btn { display:inline-block; margin-top:10px; padding:10px 14px; background:#4f46e5; color:#fff; border-radius:8px; text-decoration:none; }
  </style>
</head>
<body>
  <div class="card">
    <div class="loading" id="spinner"></div>
    <div class="title">Redirigiendo...</div>
    <div class="msg" id="msg">Comprobando enlace</div>
    <div class="small" id="debug" style="display:none;"></div>
    <a class="btn" id="manual" style="display:none;" href="#">Abrir manual</a>
  </div>

  <script>
    const spinner = document.getElementById('spinner');
    const msgEl = document.getElementById('msg');
    const debugEl = document.getElementById('debug');
    const manualBtn = document.getElementById('manual');

    const API_TIMEOUT = 8000; // ms

    // obtiene el código: primero prueba query param "c", si no, usa el último segmento del pathname
    function obtenerCodigo() {
      const params = new URLSearchParams(window.location.search);
      let code = params.get('c');
      if (code) return code.trim();

      const path = window.location.pathname || '/';
      const parts = path.split('/').filter(Boolean);
      if (parts.length === 0) return null;
      const last = parts[parts.length - 1];
      if (last.toLowerCase().endsWith('.html')) return null;
      return decodeURIComponent(last).trim();
    }

    function fetchWithTimeout(url, opts = {}, timeout = API_TIMEOUT) {
      return Promise.race([
        fetch(url, opts),
        new Promise((_, rej) => setTimeout(() => rej(new Error('Tiempo de espera agotado')), timeout))
      ]);
    }

    function setLoading(loading, text = 'Comprobando enlace') {
      spinner.style.display = loading ? 'block' : 'none';
      msgEl.textContent = text;
    }

    function mostrarError(text, details = '') {
      setLoading(false);
      msgEl.innerHTML = `<span class="error">${text}</span>`;
      debugEl.style.display = 'block';
      debugEl.textContent = details || `URL actual: ${window.location.href}`;
      manualBtn.style.display = 'inline-block';
      manualBtn.textContent = 'Ir al inicio';
      manualBtn.href = window.location.origin;
    }

    function showManualLink(url) {
      setLoading(false, 'Enlace encontrado');
      debugEl.style.display = 'block';
      debugEl.innerHTML = `Destino: <a href="${url}" target="_blank" rel="noopener">${url}</a>`;
      manualBtn.style.display = 'inline-block';
      manualBtn.textContent = 'Abrir enlace';
      manualBtn.href = url;
      manualBtn.focus();
    }

    async function buscarYRedirigir(code) {
      try {
        setLoading(true, 'Buscando enlace...');

        const cleanCode = code.trim();

        const response = await fetchWithTimeout('/api/supabase', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'getByCode', code: cleanCode })
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || `HTTP ${response.status}`);
        }

        const data = await response.json();

        if (!data || !data.url) {
          mostrarError('Enlace no encontrado.', `Código: ${cleanCode}`);
          return;
        }

        // Mostrar destino y redirigir tras breve delay para que usuario vea la confirmación
        showManualLink(data.url);

        // Incrementar visitas en background (no bloquear)
        fetch('/api/supabase', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'incrementVisits', code: cleanCode })
        }).catch(err => console.warn('Inc visits failed:', err));

        // Redirigir después de 600ms
        setTimeout(() => window.location.replace(data.url), 600);

      } catch (err) {
        console.error('Error de red:', err);
        mostrarError('No se pudo obtener el enlace.', err.message || String(err));
      }
    }

    // flujo principal
    (async function () {
      const code = obtenerCodigo();
      if (!code) {
        mostrarError('Código no válido.');
        return;
      }

      debugEl.style.display = 'block';
      debugEl.textContent = `Código detectado: ${code}`;
      await buscarYRedirigir(code);
    })();
  </script>
</body>
</html>
